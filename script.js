// Teacher Portfolio System - Fixed Version
console.log('ğŸ¯ Ù†Ø¸Ø§Ù… Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');

// Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
let portfolioData = {
    arabic: [],
    english: [],
    quran: [],
    math: [],
    science: [],
    activities: []
};

let currentTab = 'dashboard';
let isAdminMode = false;

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
    setupEventListeners();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    loadData();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø«ÙŠÙ…
    setupTheme();
    
    console.log('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
});

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
function setupEventListeners() {
    console.log('ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«...');
    
    // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
        });
    });
    
    // Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    // Ø²Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    document.getElementById('adminBtn').addEventListener('click', function() {
        isAdminMode = !isAdminMode;
        document.getElementById('adminModal').style.display = 'flex';
        showToast(isAdminMode ? 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…ÙØ¹Ù„' : 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø¹Ø·Ù„', 'info');
    });
    
    // Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    document.getElementById('backupBtn').addEventListener('click', backupData);
    
    // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveItem();
    });
    
    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±
    document.getElementById('image1').addEventListener('change', function(e) {
        previewImage(e.target, 'preview1');
    });
    
    document.getElementById('image2').addEventListener('change', function(e) {
        previewImage(e.target, 'preview2');
    });
    
    // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const text = this.querySelector('span').textContent;
            showToast(`ØªÙ… ØªÙ†ÙÙŠØ°: ${text}`, 'success', 2000);
        });
    });
    
    console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«');
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function loadData() {
    console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Ø£ÙˆÙ„Ø§Ù‹
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            loadFromFirebase();
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            loadFromLocalStorage();
        }
    } catch (error) {
        console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·:', error);
        loadFromLocalStorage();
    }
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
function loadFromFirebase() {
    console.log('â˜ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase...');
    
    const db = firebase.firestore();
    
    db.collection('portfolio').doc('data').get()
        .then((doc) => {
            if (doc.exists) {
                portfolioData = doc.data();
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
                updateConnectionStatus('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 'success', 3000);
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
                db.collection('portfolio').doc('data').set(portfolioData);
                console.log('ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Firebase');
                updateConnectionStatus('Ø¬Ø¯ÙŠØ¯');
            }
            updateUI();
        })
        .catch((error) => {
            console.log('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Firebase:', error);
            loadFromLocalStorage();
        });
}

// ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
function loadFromLocalStorage() {
    console.log('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ...');
    
    const savedData = localStorage.getItem('teacherPortfolioData');
    
    if (savedData) {
        try {
            portfolioData = JSON.parse(savedData);
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
            updateConnectionStatus('Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'info', 3000);
        } catch (error) {
            console.log('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            portfolioData = {
                arabic: [],
                english: [],
                quran: [],
                math: [],
                science: [],
                activities: []
            };
            updateConnectionStatus('Ø¬Ø¯ÙŠØ¯');
        }
    } else {
        console.log('ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©');
        updateConnectionStatus('Ø¬Ø¯ÙŠØ¯');
    }
    
    updateUI();
}

// Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function saveData() {
    console.log('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    
    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
    try {
        localStorage.setItem('teacherPortfolioData', JSON.stringify(portfolioData));
        console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹');
    } catch (error) {
        console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ:', error);
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase
    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
        firebase.firestore().collection('portfolio').doc('data').set(portfolioData)
            .then(() => {
                console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase');
                updateConnectionStatus('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
            })
            .catch((error) => {
                console.log('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Firebase:', error);
                updateConnectionStatus('Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·');
            });
    }
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    const iconElement = document.getElementById('statusIcon');
    
    if (statusElement) statusElement.textContent = status;
    
    if (iconElement) {
        iconElement.className = 'status-icon ';
        if (status.includes('Ù…ØªØµÙ„')) {
            iconElement.classList.add('online');
        } else if (status.includes('Ù…Ø­Ù„ÙŠ')) {
            iconElement.classList.add('local');
        } else {
            iconElement.classList.add('offline');
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
function updateUI() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©...');
    
    updateDashboardStats();
    updateRecentActivity();
    
    if (currentTab !== 'dashboard') {
        renderSectionData(currentTab);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
function updateDashboardStats() {
    console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalItems = Object.values(portfolioData).reduce((sum, arr) => sum + arr.length, 0);
    
    let totalImages = 0;
    Object.values(portfolioData).forEach(arr => {
        arr.forEach(item => {
            if (item.images && Array.isArray(item.images)) {
                totalImages += item.images.length;
            }
        });
    });
    
    // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
    const thisMonth = new Date().getMonth();
    const thisYear = new Date().getFullYear();
    
    const thisMonthItems = Object.values(portfolioData).reduce((sum, arr) => 
        sum + arr.filter(item => {
            const itemDate = new Date(item.timestamp || Date.now());
            return itemDate.getMonth() === thisMonth && itemDate.getFullYear() === thisYear;
        }).length, 0);
    
    // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    const completionRate = totalItems > 0 ? Math.min(100, Math.floor((totalItems / 100) * 100)) : 0;
    
    // ØªØ­Ø¯ÙŠØ« DOM
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('totalImages').textContent = totalImages;
    document.getElementById('thisMonth').textContent = thisMonthItems;
    document.getElementById('completionRate').textContent = `${completionRate}%`;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
function updateRecentActivity() {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const allItems = [];
    Object.keys(portfolioData).forEach(subject => {
        portfolioData[subject].forEach(item => {
            allItems.push({
                ...item,
                subject: subject
            });
        });
    });
    
    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    allItems.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    // Ø£Ø®Ø° 5 Ø¹Ù†Ø§ØµØ± ÙÙ‚Ø·
    const recentItems = allItems.slice(0, 5);
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    container.innerHTML = '';
    
    if (recentItems.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</h3>
                <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
            </div>
        `;
        return;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ±
    recentItems.forEach(item => {
        const activity = document.createElement('div');
        activity.className = 'activity-item';
        
        const icon = getSubjectIcon(item.subject);
        const title = item.letter || item.surah || item.concept || item.title || 'Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯';
        const time = item.date || formatDate(new Date(item.timestamp || Date.now()));
        
        activity.innerHTML = `
            <div class="activity-icon">
                <i class="${icon}"></i>
            </div>
            <div class="activity-content">
                <h4>${title}</h4>
                <p>${getSubjectName(item.subject)}</p>
            </div>
            <div class="activity-time">${time}</div>
        `;
        
        container.appendChild(activity);
    });
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
function switchTab(tabId) {
    console.log(`ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${tabId}`);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-tab') === tabId) {
            item.classList.add('active');
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        if (content.id === tabId) {
            content.classList.add('active');
        }
    });
    
    currentTab = tabId;
    
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø¥Ø°Ø§ Ù„Ø²Ù…
    if (tabId !== 'dashboard') {
        renderSectionData(tabId);
    }
}

// Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
function showAddModal(subject) {
    console.log(`â• Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù€: ${subject}`);
    
    // ØªØ¹ÙŠÙŠÙ† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    const titles = {
        arabic: 'Ø¥Ø¶Ø§ÙØ© Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠ Ø¬Ø¯ÙŠØ¯',
        english: 'Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
        quran: 'Ø¥Ø¶Ø§ÙØ© Ø³ÙˆØ±Ø© Ù‚Ø±Ø¢Ù†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
        math: 'Ø¥Ø¶Ø§ÙØ© Ù…ÙÙ‡ÙˆÙ… Ø±ÙŠØ§Ø¶ÙŠ Ø¬Ø¯ÙŠØ¯',
        science: 'Ø¥Ø¶Ø§ÙØ© ØªØ¬Ø±Ø¨Ø© Ø¹Ù„Ù…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
        activities: 'Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ù…Ø¯Ø±Ø³ÙŠ Ø¬Ø¯ÙŠØ¯'
    };
    
    document.getElementById('modalTitle').textContent = titles[subject] || 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯';
    document.getElementById('modalSubject').value = subject;
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('addForm').reset();
    document.getElementById('preview1').innerHTML = '';
    document.getElementById('preview2').innerHTML = '';
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('addModal').style.display = 'flex';
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
function previewImage(input, previewId) {
    const file = input.files[0];
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© (5MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)', 'error', 3000);
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById(previewId);
        preview.innerHTML = `<img src="${e.target.result}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©">`;
    };
    reader.readAsDataURL(file);
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ±
function saveItem() {
    console.log('ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ±...');
    
    const subject = document.getElementById('modalSubject').value;
    const title = document.getElementById('itemTitle').value.trim();
    const description = document.getElementById('itemDescription').value.trim();
    
    if (!title) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'error', 3000);
        return;
    }
    
    showToast('Ø¬Ø§Ø±Ù Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±...', 'info', 2000);
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ù†ØµØ±
    const item = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        date: new Date().toLocaleDateString('ar-SA'),
        title: title,
        description: description
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø®Ø§ØµØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©
    switch(subject) {
        case 'arabic':
            item.letter = title;
            break;
        case 'english':
            item.letter = title;
            break;
        case 'quran':
            item.surah = title;
            break;
        case 'math':
        case 'science':
            item.concept = title;
            break;
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
    const image1 = document.getElementById('image1').files[0];
    const image2 = document.getElementById('image2').files[0];
    
    item.images = [];
    
    if (image1) {
        convertImageToBase64(image1).then(base64 => {
            item.images.push(base64);
            if (image2) {
                convertImageToBase64(image2).then(base642 => {
                    item.images.push(base642);
                    completeSave(item, subject);
                });
            } else {
                completeSave(item, subject);
            }
        });
    } else {
        completeSave(item, subject);
    }
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
function convertImageToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            resolve(e.target.result);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸
function completeSave(item, subject) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ©
    if (!portfolioData[subject]) {
        portfolioData[subject] = [];
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
    portfolioData[subject].push(item);
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    saveData();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateUI();
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    closeModal('addModal');
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­ âœ“', 'success', 3000);
}

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
function renderSectionData(subject) {
    const container = document.getElementById(`${subject}Items`);
    if (!container) return;
    
    const items = portfolioData[subject] || [];
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    container.innerHTML = '';
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="${getSubjectIcon(subject)}"></i>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</h3>
                <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯</p>
                <button class="btn-primary mt-20" onclick="showAddModal('${subject}')">
                    <i class="fas fa-plus"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¹Ù†ØµØ±
                </button>
            </div>
        `;
        return;
    }
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ±
    items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        
        const title = item.letter || item.surah || item.concept || item.title || 'Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
        const date = item.date || formatDate(new Date(item.timestamp));
        
        card.innerHTML = `
            <div class="item-header">
                <div>
                    <div class="item-title">${title}</div>
                    <div class="item-date">${date}</div>
                </div>
                <div class="item-actions">
                    <button class="btn-icon" onclick="editItem('${subject}', '${item.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteItem('${subject}', '${item.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="item-body">
                <div class="item-description">${item.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                <div class="item-images">
                    <div class="item-image" onclick="viewImage('${item.images?.[0] || ''}')">
                        ${item.images && item.images[0] ? 
                            `<img src="${item.images[0]}" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">` : 
                            '<div class="item-image empty"><i class="fas fa-image"></i></div>'
                        }
                    </div>
                    <div class="item-image" onclick="viewImage('${item.images?.[1] || ''}')">
                        ${item.images && item.images[1] ? 
                            `<img src="${item.images[1]}" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">` : 
                            '<div class="item-image empty"><i class="fas fa-image"></i></div>'
                        }
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(card);
    });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±
function editItem(subject, itemId) {
    showToast('Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info', 2000);
}

// Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±
function deleteItem(subject, itemId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
        return;
    }
    
    showToast('Ø¬Ø§Ø±Ù Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±...', 'info', 2000);
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
    portfolioData[subject] = portfolioData[subject].filter(item => item.id !== itemId);
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    saveData();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    updateUI();
    
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 'success', 3000);
}

// Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
function viewImage(url) {
    if (!url) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©', 'info', 2000);
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    const viewer = document.createElement('div');
    viewer.className = 'image-viewer';
    viewer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    viewer.innerHTML = `
        <img src="${url}" style="max-width: 95%; max-height: 95%; object-fit: contain;">
        <button style="
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ff0844;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        " onclick="this.parentElement.remove()">&times;</button>
    `;
    
    viewer.onclick = function(e) {
        if (e.target === this) {
            this.remove();
        }
    };
    
    document.body.appendChild(viewer);
}

// Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
function backupData() {
    const dataStr = JSON.stringify(portfolioData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileName = `teacher-portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileName);
    linkElement.click();
    
    showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'success', 3000);
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function restoreBackup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const restoredData = JSON.parse(e.target.result);
                portfolioData = restoredData;
                saveData();
                updateUI();
                showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'success', 3000);
            } catch (error) {
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø©', 'error', 3000);
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

// Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
function clearLocalStorage() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.')) {
        localStorage.removeItem('teacherPortfolioData');
        portfolioData = {
            arabic: [],
            english: [],
            quran: [],
            math: [],
            science: [],
            activities: []
        };
        saveData();
        updateUI();
        showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success', 3000);
    }
}

// ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function exportAllData() {
    const dataStr = JSON.stringify(portfolioData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileName = `teacher-portfolio-export-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileName);
    linkElement.click();
    
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success', 3000);
}

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function showPrintModal() {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...', 'info', 2000);
    
    setTimeout(() => {
        window.print();
        showToast('Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success', 2000);
    }, 1000);
}

// Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF
function exportToPDF() {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù PDF...', 'info', 2000);
    
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© jsPDF
    setTimeout(() => {
        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF', 'success', 3000);
    }, 1500);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø«ÙŠÙ…
function setupTheme() {
    const savedTheme = localStorage.getItem('portfolioTheme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    const themeBtn = document.getElementById('themeToggle');
    if (savedTheme === 'dark') {
        themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
    }
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('portfolioTheme', newTheme);
    
    const themeBtn = document.getElementById('themeToggle');
    themeBtn.innerHTML = newTheme === 'dark' ? 
        '<i class="fas fa-sun"></i>' : 
        '<i class="fas fa-moon"></i>';
    
    showToast(`Ø§Ù„ÙˆØ¶Ø¹ ${newTheme === 'dark' ? 'Ø§Ù„Ø¯Ø§ÙƒÙ†' : 'Ø§Ù„ÙØ§ØªØ­'} Ù…ÙØ¹Ù„`, 'info', 2000);
}

// Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle',
        warning: 'fas fa-exclamation-triangle'
    };
    
    toast.innerHTML = `
        <i class="${icons[type] || 'fas fa-info-circle'}"></i>
        <div class="toast-content">
            <div class="toast-title">${type === 'success' ? 'Ù†Ø¬Ø§Ø­' : type === 'error' ? 'Ø®Ø·Ø£' : 'Ù…Ø¹Ù„ÙˆÙ…Ø©'}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOutLeft 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }
    }, duration);
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø¥Ø²Ø§Ù„Ø©
    if (!document.querySelector('#toastStyles')) {
        const style = document.createElement('style');
        style.id = 'toastStyles';
        style.textContent = `
            @keyframes slideOutLeft {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(-100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø§Ø¯Ø©
function getSubjectIcon(subject) {
    const icons = {
        arabic: 'fas fa-book',
        english: 'fas fa-language',
        quran: 'fas fa-book-quran',
        math: 'fas fa-calculator',
        science: 'fas fa-flask',
        activities: 'fas fa-chalkboard-teacher'
    };
    return icons[subject] || 'fas fa-file';
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©
function getSubjectName(subject) {
    const names = {
        arabic: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        english: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
        quran: 'Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…',
        math: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
        science: 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
        activities: 'Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª'
    };
    return names[subject] || subject;
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
function formatDate(date) {
    return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.switchTab = switchTab;
window.showAddModal = showAddModal;
window.closeModal = closeModal;
window.saveItem = saveItem;
window.editItem = editItem;
window.deleteItem = deleteItem;
window.viewImage = viewImage;
window.showPrintModal = showPrintModal;
window.exportToPDF = exportToPDF;
window.backupData = backupData;
window.toggleTheme = toggleTheme;
window.clearLocalStorage = clearLocalStorage;
window.restoreBackup = restoreBackup;
window.exportAllData = exportAllData;

console.log('ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²! Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.');
